{"version":3,"sources":["../../src/services/auth.service.ts"],"sourcesContent":["import { hash, compare } from 'bcrypt';\nimport { sign } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport { CreateUserDto } from '@dtos/users.dto';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, TokenData } from '@interfaces/auth.interface';\nimport { User } from '@interfaces/users.interface';\nimport userModel from '@models/users.model';\nimport { isEmpty } from '@utils/util';\n\nclass AuthService {\n  public users = userModel;\n\n  public async signup(userData: CreateUserDto): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, 'userData is empty');\n\n    const findUser: User = await this.users.findOne({ userName: userData.userName });\n    if (findUser) throw new HttpException(409, `This username already exists`);\n\n    const hashedPassword = await hash(userData.password, 10);\n    const createUserData: User = await this.users.create({ ...userData, password: hashedPassword });\n\n    createUserData.password = undefined;\n    return createUserData;\n  }\n\n  public async login(userData: CreateUserDto): Promise<{ tokenData: TokenData; findUser: User }> {\n    if (isEmpty(userData)) throw new HttpException(400, 'userData is empty');\n\n    const findUser: User = await this.users.findOne({ userName: userData.userName });\n    if (!findUser) throw new HttpException(404, `This user name ${userData.userName} was not found`);\n\n    const isPasswordMatching: boolean = await compare(userData.password, findUser.password);\n    if (!isPasswordMatching) throw new HttpException(409, 'Password is not matching');\n\n    const tokenData = this.createToken(findUser);\n    findUser.password = undefined;\n    return { findUser, tokenData };\n  }\n\n  public async logout(userData: User): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, 'userData is empty');\n\n    const findUser: User = await this.users.findOne({ userName: userData.userName, password: userData.password });\n    if (!findUser) throw new HttpException(404, `This user name ${userData.userName} was not found`);\n\n    return findUser;\n  }\n\n  public createToken(user: User): TokenData {\n    const dataStoredInToken: DataStoredInToken = { _id: user._id };\n    const secretKey: string = SECRET_KEY;\n    const expiresIn: number = 60 * 60 * 24 * 1000;\n\n    return { expiresIn, token: sign(dataStoredInToken, secretKey, { expiresIn }) };\n  }\n}\n\nexport default AuthService;\n"],"names":["AuthService","signup","userData","isEmpty","HttpException","findUser","users","findOne","userName","hashedPassword","hash","password","createUserData","create","undefined","login","isPasswordMatching","compare","tokenData","createToken","logout","user","dataStoredInToken","_id","secretKey","SECRET_KEY","expiresIn","token","sign","userModel"],"mappings":";;;;+BA0DA;;;eAAA;;;wBA1D8B;8BACT;wBACM;+BAEG;mEAGR;sBACE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAExB,IAAA,AAAMA,cAAN,MAAMA;IAGJ,MAAaC,OAAOC,QAAuB,EAAiB;QAC1D,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK;QAEpD,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,UAAUN,SAASM,QAAQ;QAAC;QAC9E,IAAIH,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,4BAA4B,CAAC;QAEzE,MAAMK,iBAAiB,MAAMC,IAAAA,YAAI,EAACR,SAASS,QAAQ,EAAE;QACrD,MAAMC,iBAAuB,MAAM,IAAI,CAACN,KAAK,CAACO,MAAM,CAAC,wCAAKX;YAAUS,UAAUF;;QAE9EG,eAAeD,QAAQ,GAAGG;QAC1B,OAAOF;IACT;IAEA,MAAaG,MAAMb,QAAuB,EAAqD;QAC7F,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK;QAEpD,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,UAAUN,SAASM,QAAQ;QAAC;QAC9E,IAAI,CAACH,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,eAAe,EAAEF,SAASM,QAAQ,CAAC,cAAc,CAAC;QAE/F,MAAMQ,qBAA8B,MAAMC,IAAAA,eAAO,EAACf,SAASS,QAAQ,EAAEN,SAASM,QAAQ;QACtF,IAAI,CAACK,oBAAoB,MAAM,IAAIZ,4BAAa,CAAC,KAAK;QAEtD,MAAMc,YAAY,IAAI,CAACC,WAAW,CAACd;QACnCA,SAASM,QAAQ,GAAGG;QACpB,OAAO;YAAET;YAAUa;QAAU;IAC/B;IAEA,MAAaE,OAAOlB,QAAc,EAAiB;QACjD,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK;QAEpD,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,UAAUN,SAASM,QAAQ;YAAEG,UAAUT,SAASS,QAAQ;QAAC;QAC3G,IAAI,CAACN,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,eAAe,EAAEF,SAASM,QAAQ,CAAC,cAAc,CAAC;QAE/F,OAAOH;IACT;IAEOc,YAAYE,IAAU,EAAa;QACxC,MAAMC,oBAAuC;YAAEC,KAAKF,KAAKE,GAAG;QAAC;QAC7D,MAAMC,YAAoBC,kBAAU;QACpC,MAAMC,YAAoB,KAAK,KAAK,KAAK;QAEzC,OAAO;YAAEA;YAAWC,OAAOC,IAAAA,kBAAI,EAACN,mBAAmBE,WAAW;gBAAEE;YAAU;QAAG;IAC/E;;QA5CA,uBAAOpB,SAAQuB,mBAAS;;AA6C1B;MAEA,WAAe7B"}